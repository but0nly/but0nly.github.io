---
title: 关于使用 IndexDB 的选型以及碰到的问题
date: 2025-01-18
tags: 
  - 前端
  - 缓存
categories: 前端
keyworks:
  - IndexedDB
  - 缓存
---

## 背景
最近在公司内负责做一个工作流编排模块,由于存在节点过多,用户写入数据过多的场景,继而会有些用户会因为误触其他地方或者是页面刷新,导致填写了半天的数据一个没存下来.

### 解决方案
由于是使用的react flow, 前端设计器的所需的数据类型为JSON, 发送给后端的也是JSON, 那这就好办了,只需要把JSON在前端缓存起来就好了. 
我一开始是打算使用Localstorage, 后面也发现了两个不满足条件的特性,
1. 存储量小, 一个大的JSON就有可能几百kb了,存不了多少个.
2. 同步模式, 会阻塞主线程.这是关键,因为需要保留上一次的操作, 频繁操作是不可避免的.

然后发现浏览器还有个IndexedDB完成满足以上两个条件
1. 磁盘存储, 大小 > 250mb, 够够的了.
2. 异步模式,不阻塞UI,性能更好!!!

所以最后果断选中了IndexedDB.
只需要在统一触发change的地方去存储新的JSON即可.

### 开发中发现问题
开发中发现, 如果频繁更新IndexedDB的话会导致数据丢失，查了下原因, 原理跟SQL一样,不能频繁的更新.

#### 频繁更新的解决方案

内存缓存 + 节流 + 批量写入

1. 创建一个JS对象，用于存储每次操作的`key`和`value`；
2. 创建一个`autoSave`方法，里面就是通过创建`readwrite`事务，然后`put`新的配置信息。
3. 给`autoSave`添加节流，每次触发1s后执行。
4. 创建一个JS赋值函数，附带监听JS对象的赋值是否存在==变化==
5. 如果存在变化就`autoSave`
6. 完美解决批量更新导致数据丢失的*Bug*
