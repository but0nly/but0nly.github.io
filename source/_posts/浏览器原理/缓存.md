---
title: HTTP 缓存
date: 2023-10-06
tags:
 - 前端
 - 浏览器
categories: 前端
keywords: 
 - 缓存
 - HTTP
---

两小节
- *http*的缓存机制（强缓存 + 协商缓存）
- 刷新操作方式，对缓存的影响
--- 
## 缓存

1. 把一些没有必要再获取的东西，存储起来
2. 为什么需要缓存？
	- cpu的计算都很快（毫秒级别），但是网络请求是最慢的，再怎么也需要个（几百毫秒）
	- 有些很关键的性能优化得从网络去入手（为了访问得更快）
		- 减少体积
		- 减少请求次数

--- 
## 强制缓存

1. 客户端发出初次请求
2. 服务端认为这个资源可以被缓存
3. 返回资源并加上`Cache-Contorl`
4. 这个资源就会被存在本地
5. 当我们发出去第二次请求，如果`Cache-Contorl`设置的时间没有结束
6. 浏览器会帮我们从本地去取这个资源，不会发送至服务端
7. 但缓存失效时，我们会再次请求服务端
#### Cache-Contorl
- `max-age` （单位s）
- `no-cache` （别被名字给带偏了，这个是强制协商，而不是不缓存）
- `no-store` （不缓存）
- `private`
- `public`：公开共享，*中间代理服务器*和*CDN*也可以缓存这个文件。
- `immunitable`：不可变，告诉浏览器**不要执行任何启发式检查**，完全相信`max-age`
#### Expires
- 也是控制缓存过期
- 被`Cache-Contorl`替代
  
#### 业务体现
适用于不经常变动的静态资源，例如：列表的筛选的下拉，通过减少请求次数来提高加载速度和减少服务器压力。

--- 
## 协商缓存（对比缓存）

服务端缓存策略
服务端判断客户端资源，是否和服务端的一样

- 客户端发起初次请求
- 服务端认为需要缓存这个资源
- 返回资源和资源标识
- 再次请求到服务端的时候，服务端会对比这个标识，是否有更新，
- 如果没有，则返回304，从本地拿资源（体积小）
- 如果有，则返回新的资源和新的资源标识


*协商缓存*的主要字段
- `Etag`（资源的唯一标识）服务端返回
- `If-None-Match` （资源的唯一标识）客户端发送的时候带上
- `Last-Modified` （资源最后修改时间）服务端返回
- `If-Modified-Since` （资源最后修改时间）客户端发送的时候带上

#### Last-Modified和Etag的区别

- `Etag`的优先级更高
- `Last-Modified` 只精准到毫秒等级
	- 资源被修改，内容不变，Etag会更加精确。
  
#### 业务体现
适用于频繁更新的资源。例如列表数据，通过服务器验证确保用户获取最新的数据，同时减少不必要的数据传输。

## 两者的区别

- 强缓存不会发出请求，直接从本地拿资源
- 协商缓存会发出请求，但是服务端会返回304，再从本地拿资源

## 两者的关系

- 如果`Cache-Contorl`设置的缓存过期了
- 会去查看是否有`Etag`和`Last-Modified`
- 如果有的话会先去匹配

## 刷新网页对Http缓存的影响

- 正常操作 （就是首次进页面）强缓存有效，协商缓存有效
- 手动刷新（F5刷新）强缓存失效，协商缓存有效
- 强制刷新 （ctrl + f5）强制缓存失效，协商缓存失效

## 不同资源的缓存实践
主要是根据**更新频率**和**重要性**的不同区分
- 对于更新频率高且必须最新的资源，我们需要一个**保守**的缓存策略
- 对于更新频率地且内容稳定的资源，我们需要一个**激进**的缓存策略

典型案例：
- `HTML`文档
- 静态文件`JS`、`CSS`、`Fonts`
- 媒体文件：图片、视频等。

#### HTML文档的缓存
入口文件，需要返回必须最新内容。所以需要**保守**的缓存策略
> `cache-control：no-cache`强行协商缓存，再通过`ETag`和`Last-modified`确保最新内容返回。
> - 性能优化
> - 内容新鲜

#### 静态文件的缓存
内容稳定，使用**激进**的缓存策略。目标是实现**永久缓存**，只是用强缓存
- *文件指纹*： 当url变化，浏览器就会认定这是一个全新的资源。从而强制发起请求，而不是用旧的本地资源。
- `cache-control：max-age：【一年】，public，immutale`；设置永久缓存

效果：
- 性能最大化：旧文件永不校验，新文件立即下载。
- 缓存零风险：缓存不会导致用户拿到过期资源。

#### 媒体文件
更新频率不稳定，需要强缓存+协商缓存二者结合；
- **性能 (强缓存)**：在短时间内，用户重复访问时不需要发起任何请求，速度最快。
- **新鲜度/带宽 (协商缓存)**：一旦强缓存过期，通过轻量的 `304` 校验来确认文件是否被修改，从而避免重新下载大文件。

如果使用短时长（一小时）的`max-age`，保证服务器压力和性能加速呢，我们可以：
- 在用户上传的文件后添加一个参数，例如版本号`avatar.jpg?v=1234`，如果用户更新，我们在参数后修改即可，不会修改到文件名本身。
- 对于浏览器而言，`avatar.jpg?v=1234` 是一个**全新的 URL**，它会**强制**发起网络请求，从而下载最新的头像。